name: Blender Render  # Workflow name

on:
  push:  # ✅ Runs on every commit to any branch
  workflow_dispatch:  # ✅ Allows manual triggering too

jobs:
  render-blender:
    runs-on: ubuntu-latest
    steps:

      # 1️⃣ Step: Checkout the Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Step: Install System Dependencies
      - name: Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip libegl1 ffmpeg

      # 3️⃣ Step: Install Blender
      - name: Install Blender
        run: |
          wget https://download.blender.org/release/Blender4.4/blender-4.4.3-linux-x64.tar.xz
          tar -xvf blender-4.4.3-linux-x64.tar.xz
          mv blender-4.4.3-linux-x64 ~/blender
          sudo ln -s ~/blender/blender /usr/local/bin/blender

      # 4️⃣ Step: Verify Blender Installation
      - name: Check Blender Installation
        run: |
          ls -l ~/blender
          ~/blender/blender --version || echo "❌ Blender is NOT installed!"

      # 5️⃣ Step: Debug Blender Path
      - name: Debug Blender Path
        run: |
          which blender || echo "❌ Blender path is NOT found!"

      # 6️⃣ Step: Install OBJ Import Add-on
      - name: Install OBJ Import Add-on
        run: |
          mkdir -p ~/blender/4.4/scripts/addons/
          wget -P ~/blender/4.4/scripts/addons/ https://developer.blender.org/diffusion/BMT/browse/master/io_scene_obj.py

      # 7️⃣ Step: Search for Any `.obj` File in `testing-input-output/`
      - name: Detect Any `.obj` File
        run: |
          OBJ_FILE=$(ls testing-input-output/*.obj | head -n 1)
          if [ -z "$OBJ_FILE" ]; then
            echo "❌ No .obj file found!"
            exit 1
          fi
          echo "✅ Found OBJ file: $OBJ_FILE"
          echo "OBJ_FILE=$OBJ_FILE" >> $GITHUB_ENV

      # 8️⃣ Step: Run Fluid Simulation Using the Detected `.obj` File
      - name: Run Fluid Simulation with Detected `.obj` File
        run: |
          ~/blender/blender -b --python fluid_simulation.py -- $OBJ_FILE

      # 9️⃣ Step: Verify `.blend` File Creation in `testing-input-output/`
      - name: Verify `.blend` File Creation
        run: |
          ls -l ./testing-input-output/ || echo "❌ No `.blend` file found!"

      # 🔟 Step: Commit and Push `.blend` File to Repository (Only `testing-input-output/`)
      - name: Commit and Push `.blend` File
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          git config --global user.name "$GIT_USER_NAME"
          git config --global user.email "$GIT_USER_EMAIL"

          # Explicitly add new `.blend` files
          if ls testing-input-output/*.blend 1> /dev/null 2>&1; then
            git add testing-input-output/*.blend
            git status
            git diff --cached --quiet && echo "✅ No changes to commit!" || git commit -m "Auto-update: Added latest fluid simulation .blend file"
            git push origin HEAD
          else
            echo "❌ No `.blend` file detected, skipping commit."
          fi



